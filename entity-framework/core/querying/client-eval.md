---
title: 'Evaluación de cliente frente a servidor: EF Core'
author: smitpatel
ms.date: 10/03/2019
ms.assetid: 8b6697cc-7067-4dc2-8007-85d80503d123
uid: core/querying/client-eval
ms.openlocfilehash: 5cfb05041f04246712fb699f58b407f70a75ce92
ms.sourcegitcommit: 37d0e0fd1703467918665a64837dc54ad2ec7484
ms.translationtype: HT
ms.contentlocale: es-ES
ms.lasthandoff: 10/16/2019
ms.locfileid: "72445966"
---
# <a name="client-vs-server-evaluation"></a><span data-ttu-id="65707-102">Evaluación de cliente frente a servidor</span><span class="sxs-lookup"><span data-stu-id="65707-102">Client vs. Server Evaluation</span></span>

<span data-ttu-id="65707-103">Como norma general, Entity Framework Core intenta evaluar una consulta en el servidor lo máximo posible.</span><span class="sxs-lookup"><span data-stu-id="65707-103">As a general rule, Entity Framework Core attempts to evaluate a query on the server as much as possible.</span></span> <span data-ttu-id="65707-104">EF Core convierte partes de la consulta en parámetros, que se pueden evaluar en el lado cliente.</span><span class="sxs-lookup"><span data-stu-id="65707-104">EF Core converts parts of the query into parameters, which it can evaluate on the client side.</span></span> <span data-ttu-id="65707-105">El resto de la consulta (junto con los parámetros generados) se proporciona al proveedor de base de datos para determinar la consulta de base de datos equivalente que se va a evaluar en el servidor.</span><span class="sxs-lookup"><span data-stu-id="65707-105">The rest of the query (along with the generated parameters) is given to the database provider to determine the equivalent database query to evaluate on the server.</span></span> <span data-ttu-id="65707-106">EF Core admite la evaluación de cliente parcial en la proyección de nivel superior (fundamentalmente, la última llamada a `Select()`).</span><span class="sxs-lookup"><span data-stu-id="65707-106">EF Core supports partial client evaluation in the top-level projection (essentially, the last call to `Select()`).</span></span> <span data-ttu-id="65707-107">Si la proyección de nivel superior de la consulta no se puede traducir en el servidor, EF Core capturará los datos necesarios del servidor y evaluará las partes restantes de la consulta en el cliente.</span><span class="sxs-lookup"><span data-stu-id="65707-107">If the top-level projection in the query can't be translated to the server, EF Core will fetch any required data from the server and evaluate remaining parts of the query on the client.</span></span> <span data-ttu-id="65707-108">Si EF Core detecta una expresión, en cualquier lugar que no sea la proyección de nivel superior, que no se puede traducir en el servidor, inicia una excepción en tiempo de ejecución.</span><span class="sxs-lookup"><span data-stu-id="65707-108">If EF Core detects an expression, in any place other than the top-level projection, which can't be translated to the server, then it throws a runtime exception.</span></span> <span data-ttu-id="65707-109">Vea [Funcionamiento de la consulta](xref:core/querying/how-query-works) para saber cómo determina EF Core lo que no se puede traducir al servidor.</span><span class="sxs-lookup"><span data-stu-id="65707-109">See [how query works](xref:core/querying/how-query-works) to understand how EF Core determines what can't be translated to server.</span></span>

> [!NOTE]
> <span data-ttu-id="65707-110">Antes de la versión 3.0, Entity Framework Core admitía la evaluación de cliente en cualquier parte de la consulta.</span><span class="sxs-lookup"><span data-stu-id="65707-110">Prior to version 3.0, Entity Framework Core supported client evaluation anywhere in the query.</span></span> <span data-ttu-id="65707-111">Para obtener más información, vea la [sección sobre versiones anteriores](#previous-versions).</span><span class="sxs-lookup"><span data-stu-id="65707-111">For more information, see the [previous versions section](#previous-versions).</span></span>

> [!TIP]
> <span data-ttu-id="65707-112">Puede ver un [ejemplo](https://github.com/aspnet/EntityFramework.Docs/tree/master/samples/core/Querying) de este artículo en GitHub.</span><span class="sxs-lookup"><span data-stu-id="65707-112">You can view this article's [sample](https://github.com/aspnet/EntityFramework.Docs/tree/master/samples/core/Querying) on GitHub.</span></span>

## <a name="client-evaluation-in-the-top-level-projection"></a><span data-ttu-id="65707-113">Evaluación de cliente en la proyección de nivel superior</span><span class="sxs-lookup"><span data-stu-id="65707-113">Client evaluation in the top-level projection</span></span>

<span data-ttu-id="65707-114">En el ejemplo siguiente, se usa un método auxiliar para estandarizar las direcciones URL para blogs, que se devuelven desde una base de datos de SQL Server.</span><span class="sxs-lookup"><span data-stu-id="65707-114">In the following example, a helper method is used to standardize URLs for blogs, which are returned from a SQL Server database.</span></span> <span data-ttu-id="65707-115">Como el proveedor de SQL Server no tiene información de cómo se implementa este método, no es posible traducirlo a código SQL.</span><span class="sxs-lookup"><span data-stu-id="65707-115">Since the SQL Server provider has no insight into how this method is implemented, it isn't possible to translate it into SQL.</span></span> <span data-ttu-id="65707-116">Todos los demás aspectos de la consulta se evalúan en la base de datos, pero es el cliente quien pasa la `URL` devuelta mediante este método.</span><span class="sxs-lookup"><span data-stu-id="65707-116">All other aspects of the query are evaluated in the database, but passing the returned `URL` through this method is done on the client.</span></span>

[!code-csharp[Main](../../../samples/core/Querying/ClientEval/Sample.cs#ClientProjection)]

[!code-csharp[Main](../../../samples/core/Querying/ClientEval/Sample.cs#ClientMethod)]

## <a name="unsupported-client-evaluation"></a><span data-ttu-id="65707-117">Evaluación de cliente no admitida</span><span class="sxs-lookup"><span data-stu-id="65707-117">Unsupported client evaluation</span></span>

<span data-ttu-id="65707-118">Aunque la evaluación de cliente es útil, en ocasiones puede generar un rendimiento bajo.</span><span class="sxs-lookup"><span data-stu-id="65707-118">While client evaluation is useful, it can result in poor performance sometimes.</span></span> <span data-ttu-id="65707-119">Considere la consulta siguiente, en la que ahora el método auxiliar se usa en un filtro WHERE.</span><span class="sxs-lookup"><span data-stu-id="65707-119">Consider the following query, in which the helper method is now used in a where filter.</span></span> <span data-ttu-id="65707-120">Como el filtro no se puede aplicar en la base de datos, se deben extraer todos los datos de la memoria para aplicar el filtro en el cliente.</span><span class="sxs-lookup"><span data-stu-id="65707-120">Because the filter can't be applied in the database, all the data needs to be pulled into memory to apply the filter on the client.</span></span> <span data-ttu-id="65707-121">Según el filtro y la cantidad de datos en el servidor, la evaluación de cliente podría dar lugar a un rendimiento deficiente.</span><span class="sxs-lookup"><span data-stu-id="65707-121">Based on the filter and the amount of data on the server, client evaluation could result in poor performance.</span></span> <span data-ttu-id="65707-122">Por tanto, Entity Framework Core bloquea esa evaluación de cliente e inicia una excepción en tiempo de ejecución.</span><span class="sxs-lookup"><span data-stu-id="65707-122">So Entity Framework Core blocks such client evaluation and throws a runtime exception.</span></span>

[!code-csharp[Main](../../../samples/core/Querying/ClientEval/Sample.cs#ClientWhere)]

## <a name="explicit-client-evaluation"></a><span data-ttu-id="65707-123">Evaluación explícita de cliente</span><span class="sxs-lookup"><span data-stu-id="65707-123">Explicit client evaluation</span></span>

<span data-ttu-id="65707-124">Es posible que tenga que forzar la evaluación de cliente de forma explícita en ciertos casos como los siguientes:</span><span class="sxs-lookup"><span data-stu-id="65707-124">You may need to force into client evaluation explicitly in certain cases like following</span></span>

- <span data-ttu-id="65707-125">La cantidad de datos es pequeña, por lo que la evaluación en el cliente no incurre en una gran penalización del rendimiento.</span><span class="sxs-lookup"><span data-stu-id="65707-125">The amount of data is small so that evaluating on the client doesn't incur a huge performance penalty.</span></span>
- <span data-ttu-id="65707-126">El operador de LINQ que se usa carece de traducción del lado servidor.</span><span class="sxs-lookup"><span data-stu-id="65707-126">The LINQ operator being used has no server-side translation.</span></span>

<span data-ttu-id="65707-127">En esos casos, puede participar de forma explícita en la evaluación de cliente si llamada a métodos como `AsEnumerable` o `ToList` (`AsAsyncEnumerable` o `ToListAsync` para async).</span><span class="sxs-lookup"><span data-stu-id="65707-127">In such cases, you can explicitly opt into client evaluation by calling methods like `AsEnumerable` or `ToList` (`AsAsyncEnumerable` or `ToListAsync` for async).</span></span> <span data-ttu-id="65707-128">Al usar `AsEnumerable` se haría streaming de los resultados, pero al usar `ToList` se almacenarían en búfer mediante la creación de una lista, que también consume memoria adicional.</span><span class="sxs-lookup"><span data-stu-id="65707-128">By using `AsEnumerable` you would be streaming the results, but using `ToList` would cause buffering by creating a list, which also takes additional memory.</span></span> <span data-ttu-id="65707-129">Como si se realizara la enumeración varias veces, el almacenamiento de los resultados en una lista es más útil, ya que solo hay una consulta a la base de datos.</span><span class="sxs-lookup"><span data-stu-id="65707-129">Though if you're enumerating multiple times, then storing results in a list helps more since there's only one query to the database.</span></span> <span data-ttu-id="65707-130">En función del uso determinado, debe evaluar qué método es más útil para cada caso.</span><span class="sxs-lookup"><span data-stu-id="65707-130">Depending on the particular usage, you should evaluate which method is more useful for the case.</span></span>

[!code-csharp[Main](../../../samples/core/Querying/ClientEval/Sample.cs#ExplicitClientEval)]

## <a name="potential-memory-leak-in-client-evaluation"></a><span data-ttu-id="65707-131">Posible fuga de memoria en la evaluación de cliente</span><span class="sxs-lookup"><span data-stu-id="65707-131">Potential memory leak in client evaluation</span></span>

<span data-ttu-id="65707-132">Como la traducción y compilación de consultas son costosas, EF Core almacena en caché el plan de consulta compilado.</span><span class="sxs-lookup"><span data-stu-id="65707-132">Since query translation and compilation are expensive, EF Core caches the compiled query plan.</span></span> <span data-ttu-id="65707-133">El delegado en caché puede usar el código de cliente mientras se realiza la evaluación de cliente de la proyección de nivel superior.</span><span class="sxs-lookup"><span data-stu-id="65707-133">The cached delegate may use client code while doing client evaluation of top-level projection.</span></span> <span data-ttu-id="65707-134">EF Core genera parámetros para las partes evaluadas por el cliente del árbol y reutiliza el plan de consulta en el que reemplaza los valores de parámetro.</span><span class="sxs-lookup"><span data-stu-id="65707-134">EF Core generates parameters for the client-evaluated parts of the tree and reuses the query plan by replacing the parameter values.</span></span> <span data-ttu-id="65707-135">Pero determinadas constantes del árbol de expresión no se pueden convertir en parámetros.</span><span class="sxs-lookup"><span data-stu-id="65707-135">But certain constants in the expression tree can't be converted into parameters.</span></span> <span data-ttu-id="65707-136">Si el delegado en caché contiene ese tipo de constantes, esos objetos no se pueden recolectar como elementos no utilizados porque todavía se hace referencia a ellos.</span><span class="sxs-lookup"><span data-stu-id="65707-136">If the cached delegate contains such constants, then those objects can't be garbage collected since they're still being referenced.</span></span> <span data-ttu-id="65707-137">Si este tipo de objeto contiene un elemento DbContext u otros servicios, podría hacer que el uso de memoria de la aplicación crezca con el tiempo.</span><span class="sxs-lookup"><span data-stu-id="65707-137">If such an object contains a DbContext or other services in it, then it could cause the memory usage of the app to grow over time.</span></span> <span data-ttu-id="65707-138">Este comportamiento suele ser un signo de fuga de memoria.</span><span class="sxs-lookup"><span data-stu-id="65707-138">This behavior is generally a sign of a memory leak.</span></span> <span data-ttu-id="65707-139">EF Core inicia una excepción cada vez que detecta constantes de un tipo que no se puede asignar mediante el proveedor de base de datos actual.</span><span class="sxs-lookup"><span data-stu-id="65707-139">EF Core throws an exception whenever it comes across constants of a type that can't be mapped using current database provider.</span></span> <span data-ttu-id="65707-140">Las causas comunes y sus soluciones son las siguientes:</span><span class="sxs-lookup"><span data-stu-id="65707-140">Common causes and their solutions are as follows:</span></span>

- <span data-ttu-id="65707-141">**Uso de un método de instancia**: cuando se usan métodos de instancia en una proyección de cliente, el árbol de expresión contiene una constante de la instancia.</span><span class="sxs-lookup"><span data-stu-id="65707-141">**Using an instance method**: When using instance methods in a client projection, the expression tree contains a constant of the instance.</span></span> <span data-ttu-id="65707-142">Si el método no usa ningún dato de la instancia, considere la posibilidad de convertirlo en estático.</span><span class="sxs-lookup"><span data-stu-id="65707-142">If your method doesn't use any data from the instance, consider making the method static.</span></span> <span data-ttu-id="65707-143">Si necesita datos de la instancia en el cuerpo del método, pase los datos específicos como argumento al método.</span><span class="sxs-lookup"><span data-stu-id="65707-143">If you need instance data in the method body, then pass the specific data as an argument to the method.</span></span>
- <span data-ttu-id="65707-144">**Paso de argumentos constantes al método**: este caso surge generalmente al usar `this` en un argumento para el método de cliente.</span><span class="sxs-lookup"><span data-stu-id="65707-144">**Passing constant arguments to method**: This case arises generally by using `this` in an argument to client method.</span></span> <span data-ttu-id="65707-145">Puede dividir el argumento en varios argumentos escalares, que podrá asignar el proveedor de base de datos.</span><span class="sxs-lookup"><span data-stu-id="65707-145">Consider splitting the argument in to multiple scalar arguments, which can be mapped by the database provider.</span></span>
- <span data-ttu-id="65707-146">**Otras constantes**: si se detecta una constante en cualquier otro caso, puede evaluar si es necesaria para el procesamiento.</span><span class="sxs-lookup"><span data-stu-id="65707-146">**Other constants**: If a constant is come across in any other case, then you can evaluate whether the constant is needed in processing.</span></span> <span data-ttu-id="65707-147">Si es necesario tener la constante, o bien si no puede usar una solución de los casos anteriores, cree una variable local para almacenar el valor y use la variable local en la consulta.</span><span class="sxs-lookup"><span data-stu-id="65707-147">If it's necessary to have the constant, or if you can't use a solution from the above cases, then create a local variable to store the value and use local variable in the query.</span></span> <span data-ttu-id="65707-148">EF Core convertirá la variable local en un parámetro.</span><span class="sxs-lookup"><span data-stu-id="65707-148">EF Core will convert the local variable into a parameter.</span></span>

## <a name="previous-versions"></a><span data-ttu-id="65707-149">Versiones anteriores</span><span class="sxs-lookup"><span data-stu-id="65707-149">Previous versions</span></span>

<span data-ttu-id="65707-150">La sección siguiente se aplica a las versiones de EF Core anteriores a la 3.0.</span><span class="sxs-lookup"><span data-stu-id="65707-150">The following section applies to EF Core versions before 3.0.</span></span>

<span data-ttu-id="65707-151">En las versiones anteriores de EF Core se admitía la evaluación de cliente en cualquier parte de la consulta, no solo en la proyección de nivel superior.</span><span class="sxs-lookup"><span data-stu-id="65707-151">Older EF Core versions supported client evaluation in any part of the query--not just the top-level projection.</span></span> <span data-ttu-id="65707-152">Por ese motivo las consultas similares a la publicada en la sección [Evaluación de cliente no admitida](#unsupported-client-evaluation) funcionaban correctamente.</span><span class="sxs-lookup"><span data-stu-id="65707-152">That's why queries similar to one posted under the [Unsupported client evaluation](#unsupported-client-evaluation) section worked correctly.</span></span> <span data-ttu-id="65707-153">Como este comportamiento podría provocar problemas de rendimiento inadvertidos, EF Core registró una advertencia de evaluación de cliente.</span><span class="sxs-lookup"><span data-stu-id="65707-153">Since this behavior could cause unnoticed performance issues, EF Core logged a client evaluation warning.</span></span> <span data-ttu-id="65707-154">Para obtener más información sobre cómo ver la salida de registro, vea [Registro](xref:core/miscellaneous/logging).</span><span class="sxs-lookup"><span data-stu-id="65707-154">For more information on viewing logging output, see [Logging](xref:core/miscellaneous/logging).</span></span>

<span data-ttu-id="65707-155">Opcionalmente, en EF Core se permitía cambiar el comportamiento predeterminado para iniciar una excepción o no hacer nada al realizar la evaluación de cliente (excepto para la proyección).</span><span class="sxs-lookup"><span data-stu-id="65707-155">Optionally EF Core allowed you to change the default behavior to either throw an exception or do nothing when doing client evaluation (except for in the projection).</span></span> <span data-ttu-id="65707-156">El comportamiento de inicio de excepción haría que fuese similar al de la versión 3.0.</span><span class="sxs-lookup"><span data-stu-id="65707-156">The exception throwing behavior would make it similar to the behavior in 3.0.</span></span> <span data-ttu-id="65707-157">Para cambiar el comportamiento, debe configurar las advertencias al establecer las opciones del contexto, normalmente en `DbContext.OnConfiguring`, o bien en `Startup.cs` si usa ASP.NET Core.</span><span class="sxs-lookup"><span data-stu-id="65707-157">To change the behavior, you need to configure warnings while setting up the options for your context - typically in `DbContext.OnConfiguring`, or in `Startup.cs` if you're using ASP.NET Core.</span></span>

```csharp
protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
{
    optionsBuilder
        .UseSqlServer(@"Server=(localdb)\mssqllocaldb;Database=EFQuerying;Trusted_Connection=True;")
        .ConfigureWarnings(warnings => warnings.Throw(RelationalEventId.QueryClientEvaluationWarning));
}
```
